/*	javascript-markdown-quiz - 0.5
 *
 *	(c) 2021 Aelora Web Services, LLC
 *	https://compsci.rocks/scripts/
 */

class MDQ{loadedQuestions=[];allQuestions=[];currentGroups=[];paths={bootstrap5:"https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css",marked:"https://cdnjs.cloudflare.com/ajax/libs/marked/3.0.7/marked.min.js",mathjax:"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.0/es5/tex-svg-full.min.js",mermaid:"https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.13.2/mermaid.min.js",prismJS:"https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js",prismAutoload:"https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/autoloader/prism-autoloader.min.js",prismCSS:"https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css"};parentElement=null;constructor(t){if(this.config={autoStart:!0,count:5,parent:"",lang:{correct:"Correct",incorrect:"Incorrect",check:"Check",help:"Help",true:"True",false:"False",reload:"Reload"},questions:[],theme:"",css:!0,syntaxHighlight:!0,credit:!0,reload:!0,stripRaw:!0,loadScripts:!0,...t},this.loadedQuestions=[],this.allQuestions=[],""==this.config.parent)this.parentElement=document.body;else if("string"==typeof this.config.parent){if(this.parentElement=document.querySelector(this.config.parent),null===this.parentElement)return void console.error("Could not find parent element "+this.config.parent)}else{if(!(this.config.parent instanceof HTMLElement))throw new Error("Invalid parent element.");this.parentElement=this.config.parent}console.info(this.parentElement),this.config.autoStart&&this.init()}async init(){var t;if(Array.isArray(this.config.questions)?this.allQuestions=this.config.questions:"object"==typeof this.config.questions&&(t=Object.keys(this.config.questions),this.currentGroups.length<1&&(this.currentGroups=t),this.currentGroups.forEach(t=>{t in this.config.questions?this.allQuestions=this.allQuestions.concat(this.config.questions[t]):console.error("Cannot find key "+t+" in questions")})),this.allQuestions.length<1)console.error("No questions found in config");else{for(let t=this.allQuestions.length-1;0<t;t--){var e=Math.floor(Math.random()*(t+1)),s=this.allQuestions[t];this.allQuestions[t]=this.allQuestions[e],this.allQuestions[e]=s}window.Prism=window.Prism||{},Prism.manual=!0,await this.loadFiles(),this.loadScripts(this.getScripts(),this.buildPage.bind(this)),console.info(this)}}async loadFiles(){for(const s of this.allQuestions){let t=await fetch(s);var e;if(200<=t.status&&t.status<400&&(e=await t.text(),this.loadedQuestions.push(new MDQQuestion(e,s,this.config))),this.loadedQuestions.length>=this.config.count)break}}getScripts(){if(!this.config.loadScripts)return[];let e=[];e.push(this.paths.marked),"bootstrap5"==this.config.theme&&e.push(this.paths.bootstrap5);let s=!1,i=!1,r=!1;return this.loadedQuestions.forEach(t=>{!s&&t.needsMathJax()&&(e.push(this.paths.mathjax),s=!0),!i&&t.needsMermaid()&&(e.push(this.paths.mermaid),i=!0),!r&&t.needsPrism()&&(e.push(this.paths.prismCSS),e.push(this.paths.prismJS),e.push(this.paths.prismAutoload),r=!0)}),e}getParts(t){return{frontMatter:{title:"",type:"",answer:""},body:"",explanation:""}}loadScripts(e,s){if(e.length<1)s();else{let t=e.shift();var i;this.styleLoaded(t)||this.scriptLoaded(t)?this.loadScripts(e,s):t.endsWith(".js")?((i=document.createElement("script")).src=t,i.async=!1,i.addEventListener("load",()=>{this.loadScripts(e,s)}),document.head.appendChild(i)):t.endsWith(".css")&&((i=document.createElement("link")).rel="stylesheet",i.type="text/css",i.href=t,i.media="all",i.addEventListener("load",()=>{this.loadScripts(e,s)}),document.head.appendChild(i))}}styleLoaded(t){return!!document.querySelector('style[href="'+t+'"]')}scriptLoaded(t){return!!document.querySelector('script[src="'+t+'"]')}buildPage(){!!!document.querySelector("style#mdq-css")&&this.config.css&&((t=document.createElement("style")).setAttribute("type","text/css"),t.setAttribute("id","mdq-css"),t.appendChild(document.createTextNode(this.CSSContents())),document.head.appendChild(t));var t,s=document.createElement("div");let e=document.createElement("a");if(e.setAttribute("name","mdq-top"),s.appendChild(e),s.setAttribute("class","mdq-wrap "+("bootstrap5"==this.config.theme?"container":"")),this.loadedQuestions.forEach(t=>{s.appendChild(t.element(this.config.theme))}),this.config.reload){let t=document.createElement("div");t.classList.add("mdq-reload");let e=document.createElement("button");this.isBootstrap()&&e.classList.add("btn","btn-primary"),e.innerHTML=mdq.config.lang.reload,e.addEventListener("click",t=>{let e=mdq.parentElement(),s=document.createElement("a");s.setAttribute("name","mdq-top"),e.innerHTML="",e.appendChild(s),location.hash="#mdq-top",this.init(mdq.config)}),t.appendChild(e),s.appendChild(t)}this.config.credit&&((t=document.createElement("div")).classList.add("mdq-credit"),t.innerHTML='Quiz script by <a href="https://compsci.rocks/scripts/" target="_blank">CompSci.rocks</a>',s.appendChild(t)),this.parentElement.innerHTML="",this.parentElement.appendChild(s)}static toCamelCase(t){return t.replace(/\s(.)/g,function(t){return t.toUpperCase()}).replace(/\s/g,"").replace(/^(.)/,function(t){return t.toLowerCase()})}CSSContents(){return`div.mdq-wrap .mdq-question-groups{margin-top:16px;margin-bottom:8px}div.mdq-wrap .mdq-question-groups label{padding-right:16px;margin-bottom:8px}div.mdq-wrap .mdq-question-groups input[type="checkbox"]{margin-right:8px}div.mdq-wrap .mdq-question{margin-bottom:48px;padding-top:16px;border-top:1px solid silver}div.mdq-wrap .mdq-question:first-child{border-top:none}div.mdq-wrap .mdq-question input.correct,div.mdq-wrap .mdq-question select.correct{background-color:#ccffcc !important}div.mdq-wrap .mdq-question input.incorrect,div.mdq-wrap .mdq-question select.incorrect{background-color:#ffc2b3 !important}div.mdq-wrap .mdq-mc-grid{display:grid;grid-template-columns:min-content 1fr;cursor:pointer;padding-top:16px}div.mdq-wrap .mdq-mc-grid>div{padding-right:16px}div.mdq-wrap .mdq-mc-grid>div.sel{background:#eee}div.mdq-wrap .mdq-mc-grid>div.correct{background:#ccffcc}div.mdq-wrap .mdq-mc-grid>div.incorrect{background:#ffc2b3}div.mdq-wrap .mdq-buttons button{margin-right:16px;margin-top:16px}div.mdq-wrap .mdq-explanation{margin-top:16px}div.mdq-wrap .form-select,div.mdq-wrap .form-control{width:auto;display:inline !important}div.mdq-wrap .mdq-tf-result{margin-left:16px}div.mdq-wrap .mdq-tf-result.correct{color:green}div.mdq-wrap .mdq-tf-result.incorrect{color:red}div.mdq-wrap .mdq-credit{padding-top:32px;padding-bottom:16px}div.mdq-wrap .mdq-credit a{text-decoration:none}div.mdq-wrap .mdq-credit a:hover{text-decoration:underline}div.mdq-wrap .mdq-reload{margin-top:16px;margin-bottom:16px}
`}groupCount(){return this.currentGroups.length}isBootstrap(){return"bootstrap5"==this.config.theme}static shuffle(e){for(let t=e.length-1;0<t;t--){var s=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[s],e[s]=i}return e}}class MDQQuestion{rawContent="";properties={};url="";config={};constructor(t,e,s){this.rawContent=t,this.url=e,this.config=s,this.hash=Math.random().toString(36).slice(-10);s=t.match(/^\s*?---\s*?(.*?)---/s);this.properties=s?this.parseFrontMatter(s[1]):{};let i=(t=t.replace(/^\s*?---\s*?(.*?)---/s,"").trim()).split(/---[\t ]*?([A-Za-z ]+)/g);this.markdown=i.shift().trim(),this.sections={};for(let t=0;t<i.length-1;t+=2)this.sections[MDQ.toCamelCase(i[t].trim())]=i[t+1].trim()}formatted(){var t=marked(this.markdown);return this.isFIB()&&console.error("Need to parse FIB fields"),t}element(){let e=document.createElement("div");e.setAttribute("data-hash",this.hash);let t=document.createElement("div");t.innerHTML=this.formatted(),e.appendChild(t);let s="";if(!this.isMC()){if(this.isTF())return this._elementTF(theme);if(this.isFIB())return this._elementFIB(theme);throw new Error("Unknown question type")}e.appendChild(this._elementMC()),s="MC";let i=document.createElement("div");i.classList.add("mdq-buttons");let r=document.createElement("button");if(this.useBootstrap()&&r.classList.add("btn","btn-primary"),r.setAttribute("data-hash",this.hash),r.setAttribute("data-type",s),r.setAttribute("disabled",!0),r.addEventListener("click",t=>{this.checkAnswer()}),r.innerHTML=this.config.lang.check+"...",i.appendChild(r),void 0!==this.sections.explanation){let t=document.createElement("button");t.setAttribute("disabled",!0),t.setAttribute("data-help",1),t.setAttribute("data-hash",this.hash),this.useBootstrap()&&t.classList.add("btn","btn-secondary"),t.addEventListener("click",t=>{let e=document.querySelector('div.mdq-explanation[data-hash="'+this.hash+'"]');e&&(e.style.display="block")}),t.innerHTML=this.config.lang.help+"...",i.appendChild(t)}if(e.appendChild(i),void 0!==this.sections.explanation){let t=document.createElement("div");t.setAttribute("class","mdq-explanation"),t.setAttribute("data-hash",this.hash),t.style.display="none",t.innerHTML=marked(this.sections.explanation),e.appendChild(t)}return e}_elementMC(){let t=this.sections.answers.split(/---[\t ]*\r?\n/),r=this.getProperty("answer")??"1";if(r.match(/^[A-Za-z]{1}$/))r="ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(r.toUpperCase())+1;else if(!r.match(/^\d+?$/))return void console.error("Could not determine correct answer for question");let a=document.createElement("div");a.setAttribute("data-hash",this.hash);let e=document.createElement("div");e.classList.add("mdq-mc-grid"),e.setAttribute("data-hash",this.hash);let n=[],o=1;t.forEach(t=>{let e=document.createElement("div");e.setAttribute("data-row",o),e.setAttribute("data-hash",this.hash),e.setAttribute("data-col",0);let s=document.createElement("input");s.type="radio",s.name="ans-"+this.hash,s.setAttribute("data-row",o),s.setAttribute("data-hash",this.hash),s.setAttribute("data-c",o==r?1:0),e.appendChild(s),a.appendChild(e);let i=document.createElement("div");i.setAttribute("data-row",o),i.setAttribute("data-hash",this.hash),i.innerHTML=marked(t),n.push([e,i]),o++});let s=this.getProperty("shuffle");return void 0!==s&&!s.match(/^t.*/i)&&1!=s||(n=MDQ.shuffle(n)),n.forEach(t=>{e.appendChild(t[0]),e.appendChild(t[1])}),e.addEventListener("click",t=>{let e=t.target.closest("[data-row]");var s=e.getAttribute("data-hash"),t=e.getAttribute("data-row");let i=document.querySelector('[data-row="'+t+'"][data-hash="'+s+'"] > input');i.checked=!0;let r=document.querySelectorAll('.mdq-mc-grid[data-hash="'+s+'"] > div');r.forEach(t=>{t.classList.remove("sel","correct","incorrect")});let a=document.querySelectorAll('.mdq-mc-grid > div[data-row="'+t+'"][data-hash="'+s+'"]');a.forEach(t=>{t.classList.add("sel")}),document.querySelector('button[data-hash="'+s+'"]').disabled=!1}),a.appendChild(e),a}_elementTF(){}_elementFIB(){console.info("building FIB")}checkAnswer(){this.isMC()?this._checkAnswerMC():this.isTF()?this._checkAnswerTF():this.isFIB()&&this._checkAnswerFIB();let t=document.querySelector('button[data-help][data-hash="'+this.hash+'"]');t&&(t.disabled=!1)}_checkAnswerMC(){let t=document.querySelectorAll('div.mdq-mc-grid[data-hash="'+this.hash+'"] > div');t.forEach(t=>{t.classList.remove("sel","correct","incorrect")});let e=document.querySelector("input[name=ans-"+this.hash+"]:checked"),s=1==e.getAttribute("data-c"),i=document.querySelectorAll('div.mdq-mc-grid[data-hash="'+e.getAttribute("data-hash")+'"] > div[data-row="'+e.getAttribute("data-row")+'"][data-hash="'+e.getAttribute("data-hash")+'"]');i.forEach(t=>{t.classList.add(s?"correct":"incorrect")})}_checkAnswerTF(){}_checkAnswerFIB(){}isMC(){return"mc"==this.getProperty("type").toLowerCase()}isTF(){return"tf"==this.getProperty("type").toLowerCase()}isFIB(){return"fib"==this.getProperty("type").toLowerCase()}useBootstrap(){return"bootstrap5"==this.config.theme}getProperty(t){return this.properties[t]}parseFrontMatter(t){let s={},e=t.split(/\n\r?/);return e.forEach(t=>{let e=(t=t.trim()).split(/\s*?:\s*?/);2==e.length&&(s[MDQ.toCamelCase(e[0].trim())]=e[1].trim())}),void 0===s.answer&&void 0!==s.ans&&(s.answer=s.ans),s}needsMathJax(){return!(!this.rawContent.match(/\$\$(.*?)\$\$/s)&&!this.rawContent.match(/\\\(.*?\)\\/s))}needsMermaid(){return!!this.rawContent.match(/```mermaid/s)}needsPrism(){let t=this.rawContent.match(/```([A-Za-z0-9]+)/gs),e=!1;return!!t&&(t.forEach(t=>{"```mermaid"!=t&&(e=!0)}),e)}}